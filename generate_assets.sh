#!/bin/bash

# Purpose: Generate a Dart class for assets to provide type-safe access.
#
# This script scans the ASSETS_DIR, ignores the 'fonts' subdirectory,
# and creates a Dart file at OUTPUT_FILE. It organizes assets by their
# parent folder (e.g., images, icons) and then groups them by file
# extension in a predefined order.

# --- Configuration ---
ASSETS_DIR="assets"
OUTPUT_FILE="lib/constants/app_assets.dart"
CLASS_NAME="AppAssets"

# Create the output directory if it doesn't exist
mkdir -p "$(dirname "$OUTPUT_FILE")"

# --- Script Start ---
echo "ðŸš€ Starting asset generation..."

# Clear the existing file and write the header
{
  echo "// This file is generated by a script. Do not edit."
  echo "// For more details, see generate_assets.sh."
  echo ""
  echo "class $CLASS_NAME {"
  echo "  const $CLASS_NAME._();"
  echo ""
} > "$OUTPUT_FILE"

# Find top-level directories in the assets folder (e.g., assets/images, assets/icons)
# and sort them alphabetically.
for dir in $(find "$ASSETS_DIR" -maxdepth 1 -mindepth 1 -type d | sort); do
    folder_name=$(basename "$dir")

    # --- Rule: Exclude 'fonts' directory ---
    if [[ "$folder_name" == "fonts" ]]; then
        continue
    fi

    # --- Rule: Add section comments like // === Images === ---
    # Capitalize the first letter of the folder name for the comment
    section_name_capitalized="$(tr '[:lower:]' '[:upper:]' <<< ${folder_name:0:1})${folder_name:1}"
    echo "  // === $section_name_capitalized ===" >> "$OUTPUT_FILE"

    # --- Rule: Order assets by extension ---
    # Define the desired order of file extensions. Files with other extensions will be ignored.
    extensions=("svg" "png" "jpg" "jpeg" "gif" "webp" "json" "riv")

    first_entry_in_section=true
    for ext in "${extensions[@]}"; do
        # Find all files with the current extension in the directory and its subdirectories
        found_files=$(find "$dir" -type f -name "*.$ext" | sort)

        if [[ -z "$found_files" ]]; then
            continue
        fi

        # Add a comment for the file type, e.g., // .svg
        if [ "$first_entry_in_section" = false ]; then
          echo "" >> "$OUTPUT_FILE"
        fi
        echo "  // .$ext" >> "$OUTPUT_FILE"
        first_entry_in_section=false

        for file in $found_files; do
            # --- Generate a clean, camelCase variable name from the file path ---
            # 'assets/images/onboarding/welcome_screen.png'
            # 1. Remove base dir and extension: 'images/onboarding/welcome_screen'
            var_name=$(echo "$file" | sed -e "s#^$ASSETS_DIR/##" -e "s#\.$ext##")
            # 2. Replace slashes, dashes, and spaces with underscores: 'images_onboarding_welcome_screen'
            var_name=$(echo "$var_name" | tr '/' '_' | tr '-' '_' | tr ' ' '_')
            # 3. Convert to lowerCamelCase: 'imagesOnboardingWelcomeScreen'
            var_name_camel=$(echo "$var_name" | awk -F_ '{printf "%s", $1; for(i=2; i<=NF; i++) printf "%s", toupper(substr($i,1,1)) substr($i,2)}')

            # Write the static constant to the file
            echo "  static const String $var_name_camel = '$file';" >> "$OUTPUT_FILE"
        done
    done
    echo "" >> "$OUTPUT_FILE"
done

# Write the closing brace for the class
echo "}" >> "$OUTPUT_FILE"

echo "âœ… Success! Asset class '$CLASS_NAME' generated at '$OUTPUT_FILE'."
